# 4d-presentation-2025-07-08

スライドは[こちら](https://speakerdeck.com/miyako/4d-20-r9)

#### 4D Qodly Pro - 本番環境対応可 & 顧客成功支援体制

R8からの正式名称は4D Qodly Pro。20  R2のデベロッパープレビュー（2023年9月）から1年半の開発期間およびベータ期間を経て，R8で実際のプロダクションで使用できる水準に到達した。Qodly Studioの開発ライセンスは，シルバー以上のバートナー特典であるDeveloper Proおよびゴールドまたはシルバー拡張特典のDeveloper Bundleライセンスに含まれている。4D Server版のQodly Studioの開発に必要なライセンスは，買い切り版またはサブスク版の4D Server，およびDeveloper Bundleライセンスに含まれている。Qodly Proの運用に必要なライセンスは，買い切り版またはサブスク版の4D Serverに含まれている。

4Dのフォームエディターを使えば，エンドユーザーにとって使いやすい，デスクトップクライアントのアプリケーション画面を手早く開発することができる。Qodly Studioを使えば，4D Serverにアクセスするための新たな手段として，今風の洗練されたレスポンシブなWeb画面を作成することができる。つまり，4D Qodly Proを使えば，同じデータベース・同じアプリケーションに対して，デスクトップクライアントとWeb画面という2通りのアクセスポイントを提供することができる。デスクトップ版のフォームとWeb版のフォームにそれぞれ違うコードを書くのではなく，一度，書いたコードを両方のフォームで利用できる。

Qodlyをはじめてみたい/どこから始めたら良いかわからない：[30分の無料コンサルティング](https://calendly.com/ametwalli/book-a-meeting-with-4d-qodly-pro-success-team)を申し込むことができる。

プロダクションレディに到達したことものの，これでQodlyの開発が終わるわけではない。開発部は，重要なふたつの課題に取り組んでいる。ひとつはORDAイベントを完成させること，もうひとつは国際化に対応すること。ORDAイベントは，レコードアクセスの要であるエンティティオブジェクトを作成してから手放すまで，その
ライフサイクルを最初から最後まで制御できるようにするもの。クラシック言語におけるトリガよりも包括的で，ORDAデータクラスの仕組みと完全にブレンドするような仕組み。

ローカライズについていえば，どんな4D Qodlyアプリケーションでも，複数の地域と言語に対応させることができるような，使い易くて効率的な方法を開発している。これはQodlyの進化におけるつぎの重要なステップであると認識している。

4D Qodly Proには，ページを組み立てるためのUIコンポーネントが用意されているが，それだけに限定されているわけではない。Qodlyは，独自のUIコンポーネントを自由に追加できるような仕様に作られている。そのようなオリジナルの部品であるカスタムコンポーネントを自分で設計するためにはReactのスキルが必要。

[GitHub](https://github.com/qodly/custom-components)には，Qodlyの開発チームが作成したカスタムコンポーネントが多数，公開されているので，それらを活用することもできる。データ表示・フィードバック・レイアウト・入力・ナビゲーションの5つのカテゴリーに整理されている。いずれにしても，UIを自由に拡張できるというのがポイント。前述した顧客成功チームは，この点でも助けを差し伸べることができると考えている。

#### 4D NetKit - OAuth2.0認証のレスポンスをホストWebサーバーのポートで取得

4Dで開発したデスクトップアプリケーションからGoogle WorkspaceやMicrosoft 365が提供するサービスを利用するためには，OAuth2の認証に対応していなければならない。OAuth2の認証に対応するためには，JSON Web Tokenを作成したり，認証トークンを受信できるWebサーバーを公開したり，とったことができなければならない。NetKitは，OAuthサービスとのやりとりに必要な機能をまとめたもの。このコンポーネントには，認証トークンを受信するための簡易Webサーバー機能がついており，Webライセンスがなくても利用できる。

もっとも，すでにWebライセンスを保有しており，アプリケーションをWebで公開しているのであれば，NetKitコンポーネントのWebサーバーではなく，[ホストプロジェクトのWebサーバーで認証トークンを受信](https://blog.4d.com/ja/4d-netkit-use-your-web-server-host-ports-to-retrieve-your-oauth-2-0-authentication-response/)したほうが理にかなっている。redirectURIプロパティにホストプロジェクトのWebサーバーのポート番号を指定するか，ポート番号を省略した場合，認証トークンのコールバック処理にホストのWebサーバー使われる。そうでなければ，NetKitのWebサーバーが使われる。

#### 4D NetKit - カレンダーおよびイベント

20 R9のNetKitを使えば，[Google WorkplaceおよびMicrosoft 365のカレンダーやイベントを取得](https://blog.4d.com/ja/4d-netkit-get-google-and-microsoft-365-calendar-events/)できる。OAuth 2.0でユーザーを認証した後，カレンダーやイベントのデータを取得するためのAPIが用意されている。たとえば，スケジュールを管理したり，直近に迫った予定のリマインダーを表示したりといった用途が考えられる。GoogleとMicrosoftでは，カレンダーやイベントの仕様が異なっているが，ベンダー間の違いをできるかぎりなくすようにコンポーネントが作られているので，シンプルでとても使いやすい。将来のバージョンでは，カレンダーやイベントの取得だけでなく，追加や削除もできるようになる予定。

#### コンポーネントマネージャー - 4Dバージョンに追随

20 R6では，必要なコンポーネントを自動的にインストールするためのプロジェクト依存関係，通称・コンポーネントマネージャーが追加された。20 R7ではコンポーネントの追加と削除が画面上でできるようになり，20 R8では，自動アップデートの設定ができるようになった。20 R9では，自動アップデートをどこまで進めるのか，というルールを決めることができる。

メジャー更新の手前まで，マイナー更新の手前まで，といったルールを定めることができるが，中でも注目したいのは，[4Dバージョンに追随する](https://blog.4d.com/ja/follow-4d-version-a-smarter-way-to-manage-your-dependencies/)，というルール。コンポーネントにこのルールを適用すると，4Dのリリースやバージョンに対応する最新版のコンポーネントが自動的にGitHubからダウンロードされ，インストールされるようになる。

依存関係マネージャーは，GitHubリリースのタグに使われているメジャー・マイナー・パッチ番号を比較して4Dのリリースやバージョンに対応する最新版のコンポーネントを探すようになっている。GitHubに公開されている公式のコンポーネントは，すべてこの振り方を採用しており，サードパーティのコンポーネントも同じようにすれば，4Dバージョンに追随して自動アップデートされるようになる。

#### メソッドエディター - ホストのエディターでコンポーネントのメソッドやクラスを開く

20 R9では，コンポーネントの開発と改修がずっと楽になった。従来のバージョンでは，コンポーネントをほんの少し手直しするだけでも，ホストを閉じてコンポーネントを開き，修正した後にホストを開き直す必要があった。20 R9であれば，[ホストから直接コンポーネントのソースコードをエディターで編集](https://blog.4d.com/ja/edit-and-debug-component-methods-and-classes-in-4d-from-the-host-project/)できる。編集後にプロジェクトを再起動する必要はなく，変更は直ちに反映される。共有ボリュームのプロジェクトを開発モードで開けば，クライアント/サーバー環境でも同じことができる。将来のバージョンでは，メソッドやクラスだけでなく，フォームの編集できるようになる予定。

#### シンタックスチェック - 非推奨ランゲージ要素

20 R9では，非推奨ランゲージ要素，いわゆる廃止予定コマンド等の扱いも改善されている。これまでは"_O_"という接頭辞を追加することで，コマンドや定数が非推奨であることを知らせていた。アンダースコアからはじまるトークンはメソッドエディターのタイプアヘッドにも，VS Codeのコード補完にも候補として表示されない。完全なコマンド名や定数を入力しない限り，名前が_"O_"から始まる非推奨のランゲージ要素を使うことはできなかった。

20 R9では，一歩進んで[そのようなコマンドを使用している箇所にきちんと警告が表示される](https://blog.4d.com/ja/warnings-on-deprecated-language-elements/)ようになった。加えてCommand nameコマンドが拡張され，コマンドが非推奨であるかどうかをチェックできるようなった。今後，非推奨コマンドに"_O_"という接頭辞が追加されることはない。非推奨ランゲージ要素は，その名称に関係なく，コード補完に候補として表示されない。

もちろん，余計な仕事を増やしたり，開発を邪魔したりするためにこのようなことをしているわけではない。ベストプラクティスとされる手法に則ったコーディングを推奨し，進歩に取り残されることがないよう，デベロッパを助けることが目的。いますぐ非推奨コマンドに対応する余裕がなければ，コンパイラー設定で該当する警告を無効化することもできる。

#### ラベルエディター - フォーミュラーエディターを使用

20 R9では，[ラベルエディターからフォーミュラーエディターが表示される](https://blog.4d.com/ja/formulas-in-label-wizard/)ようになった。クリックすすると，フォーミュラーエディターが表示され，数式を挿入することができる。ラベルに配置された数式をダブルクリックすると，再びフォーミュラーエディターが表示され，数式を編集することができる。文字列でコードを自由に入力することができた従来のツールとは違い，標準のフォーミュラーエディターを呼び出すので，許可されていないメソッドやコマンドはブロックされるようになる。

#### ネットワーク - TCPListener クラス

20 R8で追加されたTCPConnectionクラスを使えば，Internet Commandsプラグインを使わずに4DだけでTCPクライアントが構築できるようになった。20 R9では，TCPListenerクラスが追加され，[プラグインを使わずに4DだけでTCPサーバーを構築できる](https://blog.4d.com/ja/new-class-to-handle-incoming-tcp-connections/)ようになった。どちらのクラスもコールバック関数を呼び出すというインタフェース構造になっているため，サーバー側とクライアント側のコードには，かなりの程度，共通点がある。`onConnection`，`onData`，`onError`といったコールバック関数を実装するだけで，本格的なTCPアプリが容易に開発できる。

#### Web エリア - コールバックコンテキスト

埋め込みWebエリアでは，`$4d`グローバルオブジェクトを利用することにより，プロジェクトメソッドをコールバックをすることができる。Webエリアのjavascriptからメソッドを呼び出すことができるので，シームレスにCEFと4Dを連携させることができる。4Dメソッドのコールバックを許可した場合，すべてのプロジェクトメソッドが`$4d`オブジェクトのメンバー関数になった。手軽な判明，大雑把な仕様であると言わざるを得ない。

20 R9では，[`$4d`のメンバー関数を明示的に宣言する](https://blog.4d.com/ja/use-class-in-embedded-web-area-with-4d/)ことができる。`WA SET CONTEXT`には，原則としてクラスのインスタンスを渡すことになるが，バイナリモードの場合など，Formulaでプロジェクトメソッドをラッピングしたカスタムオブジェクトを渡すこともできる。

#### セッション管理 - ワンタイムパスコードセッショントークンの発行/共有/使用

モダンなWebアプリケーションは，ユーザー毎にセッション管理をするのが原則。問題は，外部アプリケーションやサードパーティシステムのAPIと連携しなければならない場合。たとえば，本人確認のためにメールを送信し，URLをクリックしてもらうようなとき。一旦，4Dのセッションを中断し，シェアされたURLからアクセスすることによって4Dのセッションを再開することになるが，URLを発行したセッションとは別のデバイスまたはアプリケーションがURLを開くことになるので，両者をつなぐものが必要になる。それがセッショントークン。セッショントークンは，リダイレクトやコールバックでレスポンスを返すタイプの外部APIをセッション中に呼び出すような場面でも有効。ユーザーが別デバイスで開始したセッションを引き継ぐようなときにも使える。

20 R9の新しい`Session.createOTP()`関数を使えば，[ワンタイムパスコードセッショントークンを発行・共有・使用する](https://blog.4d.com/ja/connect-your-web-apps-to-third-party-systems/)ことにより，そのようなワークフローをセキュアな仕方で簡単に実装できる。特定のセッションに紐づけられたワンタイムパスコード，つまりOTPを発行し，そのOTPをコールバックURLに含めれば良い。4DのWebサーバーは，有効なOTPを検出すると，それを発行したセッションを復元するようになっている。当然，一度，使ったOTPを再利用することはできない。

#### ユーザーエクスペリエンス - macOSプラットフォームでビルドアプリケーションのUUIDを設定

macOS Sequoia以降，システム設定のプライバシーとセキュリティは，アプリケーションの名称だけでなくUUIDもチェックされるようになった。とくにローカルネットワークアクセスはクライアントがサーバーに接続できるかを左右する重要な設定であり，これが意図せずリセットされてしまうと，再設定が必要になり，ユーザーが不便を被ってしまう。20 R8以前のビルドしたアプリケーションは，4D Volume Desktopまたは4D ServerのUUIDをそのまま継承している。同じバージョンの4Dでビルドされたアプリケーションは，システム設定からみれば，いずれもクローンのようなもの。このことはパーミッション設定が混乱する原因になっていた。

20 R9でこの問題は解消されている。ビルド時に[アプリケーション名と4Dのバージョンから計算された新しいUUIDが自動的に生成される](https://blog.4d.com/ja/defining-the-4d-built-application-uuid-for-macos/)ようになった。必要であれば，独自にUUIDをコマンドを設定することもできる。

#### 4D View Pro - カスタム関数の計算完了後にインポートコールバックを呼び出し

View Proエリアあるいはオフスクリーンエリアには，4D View Proドキュメント, SpreadJSドキュメント，Microsoft Excelスプレッドシートをインポートすることができ，エクスポートすることもできる。Excelスプレッドシートをインポートした直後にCSVなどの別形式でエクスポートすれば，実施的な変換ツールとして利用することができる。問題は，スプレッドシートのセルに動的な計算式が設定されている場合。インポート直後にすべてのカスタム関数をまず再計算してからデータをエクスポートしないと，古い値が書き出されてしまう恐れがある。

20 R9では，[3種の読み込みコマンドが改良されている](https://blog.4d.com/ja/4d-view-pro-import-callback-ensures-custom-functions-are-fully-resolved/)。まず，`VP IMPORT FROM OBJECT`にもコールバック用のパラメーターが追加された。さらに，コールバック用のパラメーターがすでにサポートされている`VP IMPORT DOCUMENT`および`VP IMPORT FORM BLOB`を含め，すべてのインポートコマンドはカスタム関数計算完了後にコールバックが呼び出されるようになった。この改良により，計算途中のデータがエクスポートされる恐れがなくなった。

`VP FLUSH COMMANDS`も同様に改良された。インポート直後のエクスポートに限らず，何らかの処理を実施してから，別の処理に進みたいようなケース全般において，カスタム関数の計算完了後にそうすることができる。

#### Write Pro - AIを使用した執筆アシスタント

20 R9では，Write Proに新しいツール，[ライティングアシスタント](https://blog.4d.com/ja/discover-your-ai-powered-writing-assistant-in-4d-write-pro/)が追加された。文章の下書き・手直し・要約・翻訳にAIを使うことがあるが，その都度，ChatGPTを使って4Dに戻る代わりに，4Dの中で直接AIを使うことができる。使い方は簡単で，OpenAIであらかじめ発行しておいたAPIキーをWP SetAIKeyコマンドに渡すだけ。一旦，APIキーを登録すれば，Write Proツールバーの読み込み書き出しタブにAIツールが追加される。チャット画面に自然言語でプロンプトを入力するシンプルな実装。文法をチェックしたり，同じ意味のまま，より読み易くてイキイキとした文章に書き換えたり。ポップアップメニューには，要約せよ・翻訳せよ・手直しせよ，といった定番のプロンプトが用意されている。生成AIから返されたレスポンスは，標準テキストあるいはリッチテキストとしてWrite Proの本文に挿入することができる。ペーストボードにコピーすることもできる。リクエストの履歴を呼び出して，過去のプロンプトとレスポンスを表示した上で，適宜，本文中の必要な箇所に挿入することもできる。もちろん，別ウィンドウでChatGPTを開いても，同じようなことができるが，ツールが4Dに組み込まれているおかげで，コピー/ペーストの手間が省け，スタイル崩れの問題を未然に防ぐことができる。なお，YouTubeで公開されている[ウェビナー](https://www.youtube.com/watch?v=WP6QsJ5u85I)は，4D 19で追加された検索置換ツールから4D 20 R9で追加された執筆アシスタントまで，最近のWrite Pro新機能がすべて取り上げられており，具体的な例を通して使い方を学ぶことができる。

#### AIKit - 4D AI Kit コンポーネントでアプリケーションをもっと便利に

[AIKit](https://blog.4d.com/ja/unlock-the-power-of-ai-with-4d-aikit-automate-create-and-innovate/)は，Write Proに限定されず，OpenAIの可能性を4Dで活用するための汎用コンポーネント。数行のコードで画像の解析やコンテンツ生成など，AIが得意とする分野の処理を4Dアプリケーションに組み込むことができる。Anthropic・Mistralをはじめ，多くのプロバイダーがOpenAI互換のAPIを提供しており，それらも利用できる。外部ツールやスクリプトを使ってAIを呼び出すこともできるが，AIKitはコンポーネントなので，よりシームレスな仕方で4DアプリケーションにAIを統合することができる。AIKitには，30個のクラスが用意されており，すぐに使い始めることができる。今後，ビジネス用途をイメージしたAIKitベースの例題が随時公開される予定。

 #### 4D Method ユーザーグループ 第78回 - 4D.Vector

AIの世界では，発言や人物といった複雑な情報を数学的に比較できるようにするため，ベクトルを使う。ベクトルは，AIを活用する上で欠かせない概念。将来のバージョンでは，アプリケーションにAIを組み込みやすくするため，また，AIから得られた情報を解析しやすくするため，新しいタイプのオブジェクトが使えるようになる予定。[3月29日の第78回ユーザーグループのリプレー](https://4dmethod.com/2025/03/29/special-event-visual-studio-code-for-4d-developers-code-debug-and-copilot-mathieu-ferry-and-damien-fuzeau/)では，AIの活用をどのような活用方法をイメージしているのか，AIを活用してデータをどのように加工することができるか，といった具体的な例をみることができる。
